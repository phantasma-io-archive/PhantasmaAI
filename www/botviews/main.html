<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Phantasma AI</title>
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
        <link href="css/chatbot.css" rel="stylesheet" />
		
		<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>

<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

    </head>
    <body>
<script>
var endPoint = "/convo/{{chat_id}}";

console.log("Session id: {{user_id}}");
console.log("Chat id: {{chat_id}}");

var dots = 0;
var tryCount = 0;
var hasAnswer = false;    
var chatInterval = -1;

function startChatInterval() 
{
	if (chatInterval === -1) 
	{
		chatInterval = setInterval(getChat, 4000);
	}
}

function getChat() {
	console.log("Checking chat...");
    $.ajax({
        type: "GET",
        url: endPoint,
        success: function(response) {
			let current = $('#chatContent').html();
		
			console.log("Updated chat...");
			$('#chatContent').html(response);
			//hljs.highlightAll();
		
			tryCount++;
			if (tryCount >= 6) {
				location.reload();
			}				
        },
        error: function(error) {
			$('#error_message').removeClass('d-none');

            console.error("Error fetching chat: ", error);
			clearInterval(chatInterval);  // Stop the current interval
        }
    });
}

function sendChat() {
	tryCount = 0;
	console.log("Sending chat...");
	$('#sendBtn').attr('disabled', 'disabled'); // Disable the Send button

	var userText = $('#user_request_text').val();  // Get the text from the textarea

    if (!userText.trim()) {  // Check if the textarea is not empty
        alert("Please enter some text before sending.");
        return;
    }

	$('#user_request_text').val('');  
	$('#user_request_text').prop('disabled', true);
	$('#error_message').addClass('d-none');
		
	$.ajax({
		type: "POST",
		url: endPoint,
		data: {	
			message: userText  // Send the text as data
		},
		success: function(response) {
			console.log("Chat sent successfully");
			$('#chatContent').html(response);
		},
		error: function(error) {
			$('#error_message').removeClass('d-none');
			$('#user_request_text').prop('disabled', false);

			console.error("Error sending chat: ", error);
			// Handle the error
		}
	});
}

function dotsAnimation()
{
    if(dots < 3)
    {
        $('#dots').append('.');
        dots++;
    }
    else
    {
        $('#dots').html('.');
        dots = 1;
    }
}

</script>
	
        <!-- Page content-->
        <div class="container">
            <div class="text-center mt-5">
                <h1>Phantasma AI</h1>
                <p class="lead">Create your own dapp without coding!</p>
            </div>

			<section style="xbackground-color: #eee;">
			  <div class="container py-5">

				<div class="row d-flex justify-content-center">
				  <div class="col-md-10">

					<div class="card" id="chat1" style="border-radius: 15px;">
					  <div class="card-body">

						<div id="chatContent">{{#include convo}}</div>
	
					  </div>
					</div>

				  </div>
				</div>

			  </div>
			</section>

			
        </div>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
		
<script>
$(document).ready(function() {
	//hljs.highlightAll();
});

</script>
		
    </body>
</html>