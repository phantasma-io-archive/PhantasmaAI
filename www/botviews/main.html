<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Phantasma AI - Specky</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="css/chatbot.css" rel="stylesheet" />
	<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body>

<script>
var endPoint = "/convo/{{chat_id}}";

console.log("Session id: {{user_id}}");
console.log("Chat id: {{chat_id}}");

var dots = 0;
var tryCount = 0;
var hasAnswer = false;    
var chatInterval = -1;

function startChatInterval() 
{
	if (chatInterval === -1) 
	{
		chatInterval = setInterval(getChat, 4000);
	}
}

function getChat() {
	console.log("Checking chat...");
    $.ajax({
        type: "GET",
        url: endPoint,
        success: function(response) {
			let current = $('#chatContent').html();
		
			console.log("Updated chat...");
			$('#chatContent').html(response);
			//hljs.highlightAll();
		
			tryCount++;
			if (tryCount >= 6) {
				location.reload();
			}				
        },
        error: function(error) {
			$('#error_message').removeClass('d-none');

            console.error("Error fetching chat: ", error);
			clearInterval(chatInterval);  // Stop the current interval
        }
    });
}

function sendChat(userText) {
	tryCount = 0;
	console.log("Sending chat...");
	
{{#if options}}
	// Disable all options
	/*
	var allOptions = optionsList.querySelectorAll('.list-group-item');
	allOptions.forEach(function(option) {
		option.setAttribute('disabled', 'true');
	});*/
{{#else}}
	$('#sendBtn').attr('disabled', 'disabled'); // Disable the Send button
{{/if}}

	if (!userText) {
		userText = $('#user_request_text').val();  // Get the text from the textarea
	}
	
    if (!userText.trim()) {  // Check if the textarea is not empty
        alert("Please enter some text before sending.");
        return;
    }

	$('#user_request_text').val('');  
	$('#user_request_text').prop('disabled', true);
	$('#error_message').addClass('d-none');
		
	$.ajax({
		type: "POST",
		url: endPoint,
		data: {	
			message: userText  // Send the text as data
		},
		success: function(response) {
			console.log("Chat sent successfully");
			$('#chatContent').html(response);
			initHandlers();
		},
		error: function(error) {
			$('#error_message').removeClass('d-none');
			$('#user_request_text').prop('disabled', false);

			console.error("Error sending chat: ", error);
			// Handle the error
		}
	});
}

function dotsAnimation()
{
    if(dots < 3)
    {
        $('#dots').append('.');
        dots++;
    }
    else
    {
        $('#dots').html('.');
        dots = 1;
    }
}

function initHandlers()
{
{{#if options}}
    var optionsList = document.getElementById("optionsList");
    
    optionsList.addEventListener("click", function(event) {
        var clickedOption = event.target;
        
        if (clickedOption.classList.contains("list-group-item")) {
            // Handle the clicked option
            sendChat(clickedOption.id);
        }
    });
{{/if}}
	
{{#if has_controls}}
    var newConvoBtn = document.getElementById("newConvoBtn");
    var deleteConvoBtn = document.getElementById("deleteConvoBtn");

    newConvoBtn.addEventListener("click", function() {
        // Handle the "New Convo" button click
        window.location.href = 'new';
        // Your logic here (e.g., start a new conversation, refresh the chat interface, etc.)
    });

    deleteConvoBtn.addEventListener("click", function() {
        // Handle the "Delete Convo" button click
        alert("Not implemented yet...");
		// Your logic here (e.g., delete the current conversation, ask for confirmation, etc.)
    });	
{{/if}}
}

document.addEventListener("DOMContentLoaded", function() 
{
	initHandlers();
});

</script>

<div class="container">

	<div style="display: flex; justify-content: center; align-items: baseline; margin-top: 20px;">
		<h1>Phantasma AI</h1>
		<h6 style="margin-left: 10px;">v2.0</h6>
	</div>

	<div class="chat" id="chatContent">
		{{#include convo}}	
	</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
